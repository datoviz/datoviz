<!DOCTYPE html>
<html>

<head>
    <style>
        html {
            background-color: black;
        }
    </style>
    <script>
        window.i = 0;

        function tob64(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function loadJSON() {
            return JSON.parse('{{ json_contents | safe}}');
        }

        function updateRequest(buffer) {
            var contents = loadJSON();
            contents.requests = [contents.requests[4], contents.requests.at(-1)];
            contents.requests[0].content.data.buffer = tob64(buffer);
            return contents;
        }

        function submit(contents) {
            fetch("/request", {
                method: "post",
                headers: {
                    'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contents)
            }).then(res => {
                document.getElementById("img").setAttribute("src", "/render?" + window.i++);
            });
        }

        function load() {
            var contents = loadJSON();
            submit(contents);
        }

        function getBuffer() {
            let buffer = new ArrayBuffer(3 * (3 * 4 + 4 * 1));

            let pos = new Float32Array(buffer, 0, 3);
            let col = new Uint8Array(buffer, 3 * 4, 4);

            pos[0] = -1;
            pos[1] = -1;

            col[0] = 255;
            col[3] = 255;


            pos = new Float32Array(buffer, 16 + 0, 3);
            col = new Uint8Array(buffer, 16 + 3 * 4, 4);

            pos[0] = +1;
            pos[1] = -1;

            col[1] = 255;
            col[3] = 255;


            pos = new Float32Array(buffer, 32 + 0, 3);
            col = new Uint8Array(buffer, 32 + 3 * 4, 4);

            pos[0] = 0;
            pos[1] = +1;

            col[1] = 255;
            col[2] = 255;
            col[3] = 255;

            return buffer;
        }

        function update() {
            var buffer = getBuffer();
            var contents = updateRequest(buffer);
            submit(contents);
        }
    </script>
</head>

<body onload="load();">
    <img width="800" height="600" id="img" />
    <br>
    <button onclick="update();">Submit</button>
</body>

</html>
