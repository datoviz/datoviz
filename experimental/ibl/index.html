<!DOCTYPE html>
<html>

<head>
    <title>Datoviz IBL test</title>

    <!-- CSS styles -->
    <style>
        html {
            background-color: white;
        }
    </style>

    <!-- Array class -->
    <script>
        _DTYPE_MAPPING = {
            "uint8": [Uint8Array, 1],

            "uint16": [Uint16Array, 2],
            "int16": [Int16Array, 2],

            "uint32": [Uint32Array, 4],
            "int32": [Int32Array, 4],

            "float32": [Float32Array, 4],
            "float64": [Float64Array, 8],
        };

        function tob64(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function StructArray(count, dtype) {
            this.count = count;
            this.dtype = dtype;
            this.fields = {};
            this.itemsize = 0;
            for (let i = 0; i < dtype.length; i++) {

                let name = dtype[i][0];
                let dt = dtype[i][1];
                let count = dtype[i][2];
                let size = _DTYPE_MAPPING[dt][1];

                this.fields[name] = {
                    type: dt,
                    count: count,
                    itemsize: size,
                    offset: this.itemsize
                };
                this.itemsize += count * size;
            }
            this.buffer = new ArrayBuffer(count * this.itemsize);
        };

        StructArray.prototype.set = function (idx, name, values) {
            let field = this.fields[name];
            let vt = _DTYPE_MAPPING[field.type][0];
            let view = new vt(this.buffer, this.itemsize * idx + field.offset, field.count);
            for (let i = 0; i < field.count; i++) {
                view[i] = values[i];
            }
        };

        StructArray.prototype.b64 = function () {
            return tob64(this.buffer);
        }

    </script>

    <!-- Visualization client -->
    <script>
        const DEFAULT_URI = "https://ibl.flatironinstitute.org/public/cortexlab/Subjects/KS023/2019-12-10/001/alf/probe01/";
        const COUNT = 2000000; // max number of spikes

        const SESSIONS = {

            "https://ibl.flatironinstitute.org/public/cortexlab/Subjects/KS023/2019-12-10/001/alf/probe01/": {
                "times": "spikes.times.99ed1a2d-bb18-4f86-92f3-23a15b7d9972.npy",
                "clusters": "spikes.clusters.2e3a207d-6b7a-41b3-80b9-d759a6557b55.npy",
                "depths": "spikes.depths.9cbed712-3d4e-44d4-8ec8-f915a884e667.npy"
            },

            "https://ibl.flatironinstitute.org/public/churchlandlab/Subjects/CSHL047/2020-01-20/001/alf/probe00/": {
                "times": "spikes.times.32609666-84f6-4b20-8450-afc311b3e64e.npy",
                "clusters": "spikes.clusters.a44513ba-069e-443a-bcb6-1de2a5071615.npy",
                "depths": "spikes.depths.879aedc4-227d-4234-828e-9d9f78b7323e.npy",
            },

            "https://ibl.flatironinstitute.org/public/mainenlab/Subjects/ZM_2240/2020-01-21/001/alf/probe00/": {
                "times": "spikes.times.be8c4562-f83d-45c3-ba4d-7ac9eec94b85.npy",
                "clusters": "spikes.clusters.33e2b747-8cf9-48d7-9814-69c6aa30cd59.npy",
                "depths": "spikes.depths.7ba042a8-cc40-416f-8390-12b0c8f4009f.npy",
            }
        };

        // Data payload for a given session.
        function sessionJSON(uri) {
            return {
                "uri": uri,
                "spikes": SESSIONS[uri]
            };
        }

        // Load the initial JSON.
        function loadJSON() {
            var count = COUNT;
            return {
                "version": "1.0",
                "requests": [
                    {
                        "action": "create",
                        "type": "board",
                        "id": 1,
                        "content": {
                            "width": 800,
                            "height": 600,
                            "background": [255, 255, 255]
                        }
                    },
                    {
                        "action": "create",
                        "type": "graphics",
                        "id": 2,
                        "flags": 0,
                        "content": {
                            "board": 1,
                            "type": 1
                        }
                    },



                    {
                        "action": "create",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "type": 5,
                            "size": 200
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 10,
                            "slot_idx": 0,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "offset": 0,
                            "size": 200,
                            "data": {
                                "mode": "base64",
                                "buffer": "AACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAA=="
                            }
                        }
                    },



                    {
                        "action": "create",
                        "type": "dat",
                        "id": 11,
                        "content": {
                            "type": 5,
                            "size": 80
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 11,
                            "slot_idx": 1,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 11,
                        "content": {
                            "offset": 0,
                            "size": 80,
                            "data": {
                                "mode": "base64",
                                "buffer": "AAAAAAAAAAAAAEhEAAAWRAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAwAAWAIAAAAAAAAAAAAAIAMAAFgCAAAAAAAAAAAAAAAAAAAAAAAA"
                            }
                        }
                    },



                    {
                        "action": "create",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "type": 2,
                            "size": 20 * count
                        }
                    },
                    {
                        "action": "set",
                        "type": "vertex",
                        "id": 2,
                        "content": {
                            "dat": 3
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "ibl_ephys",
                                "count": count,
                                "session": sessionJSON(DEFAULT_URI)
                            }
                        }
                    },



                    {
                        "action": "record",
                        "type": "begin",
                        "id": 1
                    },
                    {
                        "action": "record",
                        "type": "viewport",
                        "id": 1,
                        "content": {
                            "offset": [
                                0,
                                0
                            ],
                            "shape": [
                                0,
                                0
                            ]
                        }
                    },
                    {
                        "action": "record",
                        "type": "draw",
                        "id": 1,
                        "content": {
                            "graphics": 2,
                            "first_vertex": 0,
                            "vertex_count": count
                        }
                    },
                    {
                        "action": "record",
                        "type": "end",
                        "id": 1
                    }
                ]
            };
        }

        // Generate a JSON request to update to a new URI.
        function updateRequest(uri) {
            const req = {
                "version": "1.0",
                "requests": [
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "ibl_ephys",
                                "count": COUNT,
                                "session": sessionJSON(uri)
                            }
                        }
                    },
                ]
            };

            return req;
        }

        // Send requests to the server.
        function submit(contents) {
            window.websocket.send(JSON.stringify(contents));
        }

        // Display an array buffer.
        function show(arrbuf) {
            const blob = new Blob([arrbuf]);
            const url = URL.createObjectURL(blob);
            const img = document.getElementById('img');
            img.src = url;
        }

        // Append a list item for a session.
        function appendSession(uri) {
            const ul = document.getElementById('ul');
            const li = document.createElement('li');
            const button = document.createElement('button');
            button.setAttribute('onclick', "select(\"" + uri + "\");");
            button.textContent = uri;
            li.appendChild(button);
            ul.appendChild(li);
        }

        // On load, create the websocket and set the onnopen, onmessage, and onclose callbacks.
        function load() {
            window.websocket = new WebSocket("ws://localhost:1234/");
            window.websocket.binaryType = "arraybuffer";

            window.websocket.onopen = function () {
                console.log('socket open');

                var contents = loadJSON();
                submit(contents);
            };

            window.websocket.onmessage = ({ data }) => {
                // display the received image
                if (data instanceof ArrayBuffer) {
                    console.log("received image");
                    show(data);
                }
            };

            window.websocket.onclose = function () {
                console.log('closing socket');
            };



            // Create the session list.
            for (uri in SESSIONS) {
                appendSession(uri);
            }



            window.zoom = 1;
            window.shift = 0;

            const img = document.getElementById('img');

            img.onwheel = function (e) {
                e.preventDefault();
                let d = -e.deltaY / Math.abs(e.deltaY);
                let z = window.zoom;
                let x = e.clientX;
                let y = e.clientY;
                let w = e.srcElement.width;

                window.zoom *= (1 + .5 * d);
                window.zoom = Math.max(1, window.zoom);

                let center = -1 + 2 * x / w;
                window.shift -= center * (1 / z - 1 / window.zoom);

                if (window.zoom != z)
                    updateMVP();
            }

            img.ondblclick = function (e) {
                reset();
            }
        }

        // Select another session.
        function select(uri) {
            var contents = updateRequest(uri);
            submit(contents);
        }



        // Return a MVP structure for a given pan and zoom.
        function mvp(px, py, zx, zy) {
            // 3 matrices 4x4: model, view, proj, and finally time
            var arr = new StructArray(1, [
                ["model", "float32", 16],
                ["view", "float32", 16],
                ["proj", "float32", 16],
                ["time", "float32", 1],
            ]);

            arr.set(0, "model", [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                0, 0, 0, 1]);
            arr.set(0, "view", [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                px, py, -2, 1]);
            arr.set(0, "proj", [
                zx, 0, 0, 0,
                0, zy, 0, 0,
                0, 0, -0.1, 0,
                0, 0, 0, 1]);
            arr.set(0, "time", [0]);

            return arr;
        }

        // Send the updated MVP struct to the server.
        function updateMVP() {
            arr = mvp(window.shift, 0, window.zoom, 1);

            const req = {
                "version": "1.0",
                "requests": [
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "base64",
                                "buffer": arr.b64()
                            }
                        }
                    },
                ]
            };

            submit(req);
        }

        // Reset the view.
        function reset() {
            window.zoom = 1;
            window.shift = 0;

            updateMVP();
        }


    </script>
</head>

<body onload="load();">
    <div style="width: 800px; padding: 0;">
        <img width="800" height="600" id="img" style="width: 800px; margin: 0; border: 1px solid #aaa;" />
        <br>
        <button onclick="reset();" style="width: 100%; height: 30px; margin: 1px;">Reset</button>
    </div>
    <ul id="ul">
    </ul>
</body>

</html>
